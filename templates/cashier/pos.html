{% extends "base.html" %}

{% block title %}POS Terminal - Cashier{% endblock %}

{% block content %}
<div style="display: grid; grid-template-columns: 1.6fr 1fr; gap: 20px;">
    <!-- Left Column -->
    <div style="display: flex; flex-direction: column; gap: 20px;">
        <!-- Shopping Cart -->
        <div class="card" style="display: flex; flex-direction: column;">
            <div class="card-header" style="padding: 12px 16px;">
                <span class="card-icon">üõí</span>
                <h2 class="card-title">Shopping Cart</h2>
            </div>
            <div class="card-body" style="padding: 20px;">
                <table class="cart-table" id="cartTable" style="min-height: 250px;">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Qty</th>
                                <th>Price</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody id="cartItems">
                            <!-- Cart items will be added here dynamically -->
                        </tbody>
                    </table>
                <div style="margin-top: 16px; display: flex; gap: 12px;">
                    <button class="btn btn-danger" onclick="removeSelectedItem()">üóëÔ∏è Remove</button>
                    <button class="btn btn-warning" onclick="clearCart()">üßπ Clear All</button>
                </div>
            </div>
        </div>

        <!-- Quick Sale -->
        <div class="card">
            <div class="card-header">
                <span class="card-icon">‚ö°</span>
                <h2 class="card-title">Quick Sale</h2>
            </div>
            <div class="card-body" style="padding: 20px;">
                <div class="quick-sale-grid">
                    {% for item in quick_items %}
                    <button class="quick-sale-tile" onclick="addQuickSaleItem({{ item.id }})">
                        <div style="font-size: 24px; margin-bottom: 6px;">{{ item.icon }}</div>
                        <div>{{ item.name }}</div>
                        <div style="color: #10b981; margin-top: 4px;">${{ "%.2f"|format(item.price) }}</div>
                    </button>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column -->
    <div style="display: flex; flex-direction: column; gap: 20px;">
        <!-- Scan Item -->
        <div class="card">
            <div class="card-header">
                <span class="card-icon">üì±</span>
                <h2 class="card-title">Scan Item</h2>
            </div>
            <div class="card-body">
                <input type="text" id="barcodeInput" placeholder="Enter barcode, product name, or scan..." autofocus autocomplete="off">
                <div id="searchResults" style="display: none; position: absolute; background: white; border: 1px solid #e2e8f0; border-radius: 6px; max-height: 200px; overflow-y: auto; width: calc(100% - 32px); margin-top: 2px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 100;"></div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 12px;" onclick="addToCart()">üõí Add to Cart</button>
            </div>
        </div>

        <!-- Total Amount -->
        <div class="total-display">
            <div class="total-label">Total Amount</div>
            <div class="total-amount" id="totalAmount">$0.00</div>
        </div>

        <!-- Payment -->
        <div class="card">
            <div class="card-header">
                <span class="card-icon">üí≥</span>
                <h2 class="card-title">Payment</h2>
            </div>
            <div class="card-body">
                <label style="font-size: 12px; color: #64748b; margin-bottom: 6px; display: block;">Payment Method</label>
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <button id="paymentMethodCash" class="btn btn-primary" style="flex: 1; padding: 10px; font-size: 14px;" onclick="setPaymentMethod('cash')">
                        üíµ Cash
                    </button>
                    <button id="paymentMethodEcocash" class="btn btn-secondary" style="flex: 1; padding: 10px; font-size: 14px;" onclick="setPaymentMethod('ecocash')">
                        üì± EcoCash
                    </button>
                </div>

                <label style="font-size: 12px; color: #64748b; margin-bottom: 6px; display: block;" id="amountLabel">Amount Received</label>
                <input type="number" id="cashReceived" placeholder="0.00" step="0.01" oninput="calculateChange()">

                <div id="changeDisplay" style="background: #f1f5f9; padding: 12px 16px; border-radius: 8px; margin-top: 12px; display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 13px; color: #64748b;">Change:</span>
                    <span style="font-size: 20px; font-weight: 700; color: #10b981;" id="changeAmount">$0.00</span>
                </div>

                <button class="btn btn-success" style="width: 100%; margin-top: 16px;" onclick="completeSale()">
                    ‚úì Complete Sale
                </button>
            </div>
        </div>

        <!-- Keypad -->
        <div class="card">
            <div class="card-header">
                <span class="card-icon">üî¢</span>
                <h2 class="card-title">Keypad</h2>
            </div>
            <div class="card-body">
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <button id="keypadModeBarcode" class="btn btn-primary" style="flex: 1; padding: 8px; font-size: 13px;" onclick="setKeypadMode('barcode')">Barcode</button>
                    <button id="keypadModePayment" class="btn btn-secondary" style="flex: 1; padding: 8px; font-size: 13px;" onclick="setKeypadMode('payment')">Payment</button>
                </div>
                <div class="keypad">
                    <button class="keypad-btn" onclick="keypadInput('7')">7</button>
                    <button class="keypad-btn" onclick="keypadInput('8')">8</button>
                    <button class="keypad-btn" onclick="keypadInput('9')">9</button>
                    <button class="keypad-btn" onclick="keypadInput('4')">4</button>
                    <button class="keypad-btn" onclick="keypadInput('5')">5</button>
                    <button class="keypad-btn" onclick="keypadInput('6')">6</button>
                    <button class="keypad-btn" onclick="keypadInput('1')">1</button>
                    <button class="keypad-btn" onclick="keypadInput('2')">2</button>
                    <button class="keypad-btn" onclick="keypadInput('3')">3</button>
                    <button class="keypad-btn clear" onclick="keypadClear()">C</button>
                    <button class="keypad-btn" onclick="keypadInput('0')">0</button>
                    <button class="keypad-btn" onclick="keypadInput('.')">.</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let cart = [];
let selectedRow = null;
let searchTimeout = null;
let paymentMethod = 'cash'; // 'cash' or 'ecocash'

// Barcode input - search as you type
document.getElementById('barcodeInput').addEventListener('input', function(e) {
    const query = e.target.value.trim();

    if (query.length < 2) {
        hideSearchResults();
        return;
    }

    // Debounce search
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        searchProducts(query);
    }, 300);
});

// Barcode input enter key
document.getElementById('barcodeInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        addToCart();
    }
});

// Search products by name or barcode
async function searchProducts(query) {
    const response = await fetch(`/api/search-products?q=${encodeURIComponent(query)}`);
    const data = await response.json();

    if (data.success && data.products.length > 0) {
        showSearchResults(data.products);
    } else {
        hideSearchResults();
    }
}

// Show search results dropdown
function showSearchResults(products) {
    const resultsDiv = document.getElementById('searchResults');
    resultsDiv.innerHTML = '';

    products.forEach(product => {
        const item = document.createElement('div');
        item.style.cssText = 'padding: 10px; cursor: pointer; border-bottom: 1px solid #e2e8f0;';
        item.innerHTML = `
            <div style="font-weight: 600;">${product.name}</div>
            <div style="font-size: 12px; color: #64748b;">Barcode: ${product.barcode} | Price: $${product.price.toFixed(2)} | Stock: ${product.stock}</div>
        `;

        item.addEventListener('mouseenter', function() {
            this.style.background = '#f1f5f9';
        });
        item.addEventListener('mouseleave', function() {
            this.style.background = 'white';
        });
        item.addEventListener('click', function() {
            selectProduct(product);
        });

        resultsDiv.appendChild(item);
    });

    resultsDiv.style.display = 'block';
}

// Hide search results
function hideSearchResults() {
    document.getElementById('searchResults').style.display = 'none';
}

// Select product from search
function selectProduct(product) {
    document.getElementById('barcodeInput').value = product.barcode;
    hideSearchResults();
    addToCart();
}

// Add to cart
async function addToCart() {
    console.log('addToCart called');
    const input = document.getElementById('barcodeInput').value.trim();
    console.log('Input value:', input);

    if (!input) {
        console.log('No input, returning');
        return;
    }

    hideSearchResults();

    console.log('Fetching product:', `/api/product/${encodeURIComponent(input)}`);
    try {
        const response = await fetch(`/api/product/${encodeURIComponent(input)}`);
        console.log('Response received:', response.status);
        const data = await response.json();
        console.log('Data:', data);

        if (data.success) {
            const product = data.product;

            // Check if product is in stock (skip for quick sale items)
            if (!product.barcode.startsWith('QUICK')) {
                if (product.stock <= 0) {
                    showError(`${product.name} is out of stock!`, 'Out of Stock');
                    document.getElementById('barcodeInput').value = '';
                    document.getElementById('barcodeInput').focus();
                    return;
                }

                // Check if adding to cart would exceed available stock
                const existingItem = cart.find(item => item.barcode === product.barcode);
                const currentCartQuantity = existingItem ? existingItem.quantity : 0;

                if (currentCartQuantity + 1 > product.stock) {
                    showWarning(`Only ${product.stock} units of ${product.name} available in stock!`, 'Stock Limit');
                    document.getElementById('barcodeInput').value = '';
                    document.getElementById('barcodeInput').focus();
                    return;
                }
            }

            const existingItem = cart.find(item => item.barcode === product.barcode);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    ...product,
                    quantity: 1
                });
            }
            updateCartDisplay();
            document.getElementById('barcodeInput').value = '';
            document.getElementById('barcodeInput').focus();
        } else {
            showError('Product not found', 'Not Found');
        }
    } catch (error) {
        console.error('Error in addToCart:', error);
        showError('Error adding to cart: ' + error.message, 'Error');
    }
}

// Add quick sale item
async function addQuickSaleItem(itemId) {
    // Format barcode as QUICK0001, QUICK0002, etc.
    const barcode = `QUICK${itemId.toString().padStart(4, '0')}`;

    // Use the regular product API now that quick sale items are in products table
    const response = await fetch(`/api/product/${encodeURIComponent(barcode)}`);
    const data = await response.json();

    if (data.success) {
        const existingItem = cart.find(item => item.barcode === data.product.barcode);
        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            cart.push({
                ...data.product,
                quantity: 1
            });
        }
        updateCartDisplay();
    } else {
        showError('Quick sale item not found', 'Not Found');
    }
}

// Update cart display
function updateCartDisplay() {
    const tbody = document.getElementById('cartItems');
    tbody.innerHTML = '';

    cart.forEach((item, index) => {
        const row = tbody.insertRow();
        row.dataset.index = index;
        row.onclick = function() {
            if (selectedRow) selectedRow.style.background = '';
            selectedRow = this;
            this.style.background = '#f1f5f9';
        };

        row.insertCell(0).textContent = item.name;
        row.insertCell(1).textContent = item.quantity;
        row.insertCell(2).textContent = `$${item.price.toFixed(2)}`;
        row.insertCell(3).textContent = `$${(item.price * item.quantity).toFixed(2)}`;
    });

    updateTotal();
}

// Update total
function updateTotal() {
    const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    document.getElementById('totalAmount').textContent = `$${total.toFixed(2)}`;
    calculateChange();
}

// Calculate change
function calculateChange() {
    const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const cash = parseFloat(document.getElementById('cashReceived').value) || 0;
    const change = cash - total;
    document.getElementById('changeAmount').textContent = `$${Math.max(0, change).toFixed(2)}`;
}

// Remove selected item
function removeSelectedItem() {
    if (selectedRow) {
        const index = parseInt(selectedRow.dataset.index);
        cart.splice(index, 1);
        selectedRow = null;
        updateCartDisplay();
    }
}

// Clear cart
function clearCart() {
    if (cart.length > 0) {
        showConfirm(
            'Are you sure you want to clear all items from the cart?',
            'Clear Cart',
            function() {
                cart = [];
                selectedRow = null;
                updateCartDisplay();
                document.getElementById('cashReceived').value = '';
            }
        );
    }
}

// Complete sale
async function completeSale() {
    if (cart.length === 0) {
        showWarning('Cart is empty', 'Empty Cart');
        return;
    }

    const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const cash = parseFloat(document.getElementById('cashReceived').value) || 0;

    if (cash < total) {
        showError('Insufficient payment', 'Payment Error');
        return;
    }

    const response = await fetch('/api/complete-sale', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            items: cart,
            cash_received: cash,
            payment_method: paymentMethod
        })
    });

    const data = await response.json();
    if (data.success) {
        // Build success message
        let message = `<div style="text-align: center; margin-bottom: 15px;">
            <div style="font-size: 24px; font-weight: 600; color: #16a34a; margin-bottom: 10px;">Sale #${data.sale_id}</div>
        </div>`;

        message += `<div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span><strong>Total:</strong></span>
                <span style="color: #16a34a; font-weight: 600;">$${data.total.toFixed(2)}</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span><strong>Cash Received:</strong></span>
                <span>$${cash.toFixed(2)}</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 2px solid #e2e8f0;">
                <span><strong>Change:</strong></span>
                <span style="font-size: 18px; font-weight: 700; color: #2563eb;">$${data.change.toFixed(2)}</span>
            </div>
        </div>`;

        // Receipt status
        if (data.receipt_printed) {
            message += '<div style="color: #16a34a; margin-bottom: 8px;">‚úì Receipt printed successfully</div>';
        } else {
            message += '<div style="color: #d97706; margin-bottom: 8px;">‚ö† Receipt saved to file (printer unavailable)</div>';
        }
        message += '<div style="color: #16a34a; margin-bottom: 8px;">‚úì Cash drawer opened</div>';

        // Show low stock alerts if any
        if (data.low_stock_alerts && data.low_stock_alerts.length > 0) {
            message += '<div style="background: #fffbeb; border: 1px solid #fbbf24; padding: 12px; border-radius: 6px; margin-top: 15px;">';
            message += '<div style="font-weight: 600; color: #d97706; margin-bottom: 8px;">‚ö†Ô∏è LOW STOCK ALERTS:</div>';
            data.low_stock_alerts.forEach(alert => {
                message += `<div style="color: #92400e; font-size: 13px; margin-top: 4px;">${alert.message}</div>`;
            });
            message += '</div>';
        }

        showSuccess(message, 'Sale Completed');

        // Clear cart
        cart = [];
        selectedRow = null;
        updateCartDisplay();
        document.getElementById('cashReceived').value = '';
        document.getElementById('barcodeInput').focus();
    } else {
        showError(data.message, 'Sale Failed');
    }
}

// Payment method functions
function setPaymentMethod(method) {
    paymentMethod = method;

    const cashBtn = document.getElementById('paymentMethodCash');
    const ecocashBtn = document.getElementById('paymentMethodEcocash');
    const changeDisplay = document.getElementById('changeDisplay');
    const amountLabel = document.getElementById('amountLabel');

    if (method === 'cash') {
        cashBtn.className = 'btn btn-primary';
        ecocashBtn.className = 'btn btn-secondary';
        changeDisplay.style.display = 'flex';
        amountLabel.textContent = 'Cash Received';
    } else {
        cashBtn.className = 'btn btn-secondary';
        ecocashBtn.className = 'btn btn-primary';
        changeDisplay.style.display = 'none';
        amountLabel.textContent = 'EcoCash Amount';
        document.getElementById('changeAmount').textContent = '$0.00';
    }

    calculateChange();
}

// Keypad functions
let keypadMode = 'barcode'; // 'barcode' or 'payment'

function setKeypadMode(mode) {
    keypadMode = mode;

    // Update button styles
    const barcodeBtn = document.getElementById('keypadModeBarcode');
    const paymentBtn = document.getElementById('keypadModePayment');

    if (mode === 'barcode') {
        barcodeBtn.className = 'btn btn-primary';
        paymentBtn.className = 'btn btn-secondary';
        document.getElementById('barcodeInput').focus();
    } else {
        barcodeBtn.className = 'btn btn-secondary';
        paymentBtn.className = 'btn btn-primary';
        document.getElementById('cashReceived').focus();
    }
}

function keypadInput(value) {
    const targetInput = keypadMode === 'barcode' ? 'barcodeInput' : 'cashReceived';
    const input = document.getElementById(targetInput);
    input.value += value;
    input.focus();

    // Trigger change calculation for payment
    if (keypadMode === 'payment') {
        calculateChange();
    }
}

function keypadClear() {
    const targetInput = keypadMode === 'barcode' ? 'barcodeInput' : 'cashReceived';
    const input = document.getElementById(targetInput);
    input.value = '';
    input.focus();

    // Trigger change calculation for payment
    if (keypadMode === 'payment') {
        calculateChange();
    }
}

// Auto-focus barcode input on page load and keep it focused
document.addEventListener('DOMContentLoaded', function() {
    const barcodeInput = document.getElementById('barcodeInput');

    // Focus on load
    barcodeInput.focus();

    // Re-focus when clicking anywhere on the page (except specific inputs)
    document.addEventListener('click', function(e) {
        // Don't interfere if clicking on payment input, buttons, or cart
        if (e.target.id !== 'cashReceived' &&
            e.target.tagName !== 'BUTTON' &&
            e.target.tagName !== 'INPUT' &&
            e.target.tagName !== 'TR' &&
            e.target.tagName !== 'TD') {
            barcodeInput.focus();
        }
    });

    // Re-focus after any action that clears the input
    const originalAddToCart = addToCart;
    window.addToCart = async function() {
        await originalAddToCart();
        setTimeout(() => barcodeInput.focus(), 100);
    };
});
</script>
{% endblock %}
